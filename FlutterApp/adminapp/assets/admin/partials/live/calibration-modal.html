          <!-- Calibration modal -->
          <div id="calibrationModal" class="calibration-modal">
            <div
              class="calibration-backdrop"
              onclick="closeCalibrationModal()"
            ></div>
            <div class="calibration-content">
              <div class="calibration-header">
                <h3>Calibration</h3>
                <div class="calibration-header-actions">
                  <button
                    id="calibrationInfoBtn"
                    type="button"
                    class="calib-btn"
                  >
                    ?
                  </button>
                  <button
                    type="button"
                    class="calibration-close"
                    onclick="closeCalibrationModal()"
                  >
                    x
                  </button>
                </div>
              </div>
              <div class="calibration-body">
                <div
                  id="calibrationInfoPopover"
                  class="calibration-info-popover"
                  aria-hidden="true"
                >
                  <div class="calibration-info-header">
                    <div class="calibration-info-title">Calibration help</div>
                    <button
                      id="calibrationInfoCloseBtn"
                      type="button"
                      class="calibration-info-close"
                    >
                      x
                    </button>
                  </div>
                  <div class="calibration-info-content">
                    <div class="calibration-info-grid">
                      <div class="calibration-info-card">
                        <div class="calibration-info-icon">1</div>
                        <div class="calibration-info-card-title">
                          Temp model calibration
                        </div>
                        <div class="calibration-info-card-text">
                          Records temperature and time while the energy-based
                          loop heats and cools the wire. Use the resulting curve
                          to fit tau/k/C so the model matches real measurements.
                        </div>
                      </div>
                      <div class="calibration-info-card">
                        <div class="calibration-info-icon">2</div>
                        <div class="calibration-info-card-title">Wire test</div>
                        <div class="calibration-info-card-text">
                          Runs the energy-based sequential loop across all
                          allowed outputs to reach and hold the target
                          temperature. This is a live test and does not save
                          history.
                        </div>
                      </div>
                      <div class="calibration-info-card">
                        <div class="calibration-info-icon">3</div>
                        <div class="calibration-info-card-title">
                          Floor model calibration
                        </div>
                        <div class="calibration-info-card-text">
                          Logs floor response using NTC (floor) and heatsink
                          (ambient) to estimate floor tau/k/C.
                        </div>
                      </div>
                    </div>

                    <div class="calibration-info-actions">
                      <div class="calibration-info-actions-title">Buttons</div>
                      <ul>
                        <li>
                          <strong>Temp Model Calibration:</strong> Start/stop
                          the model capture while the energy loop runs.
                        </li>
                        <li>
                          <strong>Start/Stop Wire Test:</strong> Run the energy
                          loop across all allowed outputs to hold the target.
                        </li>
                        <li>
                          <strong>Floor Model Calibration:</strong> Run floor
                          capture to save the floor model parameters.
                        </li>
                        <li>
                          <strong>Presence Probe:</strong> Detect connected
                          wires and update presence calibration.
                        </li>
                        <li>
                          <strong>Load History / Resume Live:</strong> View
                          saved buffer or live feed.
                        </li>
                        <li>
                          <strong>Clear Data:</strong> Clears the buffer and
                          removes the saved file.
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="calibration-hero">
                  <h4>Simple steps</h4>
                  <div class="cal-steps">
                    <div class="cal-step">
                      <span class="dot">1</span>
                      <p>
                        Model capture<br />
                        <span class="hint"
                          >Start Temp Model Calibration to log heat/cool with
                          energy packets.</span
                        >
                      </p>
                    </div>
                    <div class="cal-step">
                      <span class="dot">2</span>
                      <p>
                        Wire test<br />
                        <span class="hint"
                          >Hold a target temp and verify the energy loop (no
                          logging).</span
                        >
                      </p>
                    </div>
                    <div class="cal-step">
                      <span class="dot">3</span>
                      <p>
                        Floor model<br />
                        <span class="hint"
                          >Capture floor response with NTC + heatsink.</span
                        >
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Error details modal -->
                <div id="errorModal" class="error-modal">
                  <div class="error-backdrop" onclick="closeErrorModal()"></div>
                  <div class="error-content">
                    <div class="error-header">
                      <h3 id="eventModalTitle">Last Stop / Error</h3>
                      <button
                        type="button"
                        class="error-close"
                        onclick="closeErrorModal()"
                      >
                        x
                      </button>
                    </div>
                    <div class="error-body">
                      <div class="error-row" id="errorStateRow">
                        <span class="error-label">Current state</span>
                        <span id="errorStateText">--</span>
                      </div>
                      <div class="error-section" id="lastErrorSection">
                        <div class="error-title">Last error</div>
                        <div class="error-row">
                          <span class="error-label">Reason</span>
                          <span id="errorReasonText">--</span>
                        </div>
                        <div class="error-row">
                          <span class="error-label">Time</span>
                          <span id="errorTimeText">--</span>
                        </div>
                      </div>
                      <div class="error-section" id="lastStopSection">
                        <div class="error-title">Last stop</div>
                        <div class="error-row">
                          <span class="error-label">Reason</span>
                          <span id="stopReasonText">--</span>
                        </div>
                        <div class="error-row">
                          <span class="error-label">Time</span>
                          <span id="stopTimeText">--</span>
                        </div>
                      </div>
                      <div class="error-section" id="warningHistorySection">
                        <div class="error-title">Warnings (last 10)</div>
                        <div id="warningList" class="error-list">
                          <div class="error-empty">No warnings logged yet.</div>
                        </div>
                      </div>
                      <div class="error-section" id="errorHistorySection">
                        <div class="error-title">Errors (last 10)</div>
                        <div id="errorList" class="error-list">
                          <div class="error-empty">No errors logged yet.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Log modal -->
                <div id="logModal" class="log-modal">
                  <div class="log-backdrop" onclick="closeLogModal()"></div>
                  <div class="log-content">
                    <div class="log-header">
                      <h3>Device Log</h3>
                      <button
                        type="button"
                        class="log-close"
                        onclick="closeLogModal()"
                      >
                        x
                      </button>
                    </div>
                    <div class="log-actions">
                      <button id="logRefreshBtn" type="button" class="log-btn">
                        Refresh
                      </button>
                      <button
                        id="logClearBtn"
                        type="button"
                        class="log-btn log-clear"
                      >
                        Clear
                      </button>
                    </div>
                    <pre id="logContent" class="log-body">Loading...</pre>
                  </div>
                </div>

                <div class="calib-actionbar">
                  <div class="calib-action-group">
                    <button
                      id="startModelCalibBtn"
                      type="button"
                      class="calib-btn"
                    >
                      Temp Model Calibration
                    </button>
                    <button
                      id="stopCalibBtn"
                      type="button"
                      class="calib-btn calib-stop"
                    >
                      Stop &amp; Save
                    </button>
                  </div>
                  <div class="calib-action-group">
                    <button
                      id="calibHistoryBtn"
                      type="button"
                      class="calib-secondary"
                    >
                      Load History
                    </button>
                    <button
                      id="calibClearBtn"
                      type="button"
                      class="calib-secondary calib-danger"
                    >
                      Clear Data
                    </button>
                  </div>
                </div>

                <div class="calibration-status">
                  <div class="calib-stat">
                    Status: <span id="calibStatusText">Idle</span>
                  </div>
                  <div class="calib-stat">
                    Mode: <span id="calibModeText">--</span>
                  </div>
                  <div class="calib-stat">
                    Samples: <span id="calibCountText">0</span>
                  </div>
                  <div class="calib-stat">
                    Interval: <span id="calibIntervalText">--</span>
                  </div>
                  <div class="calib-stat">
                    Temp: <span id="calibTempText">--</span>
                  </div>
                  <div class="calib-stat">
                    Wire: <span id="calibWireText">--</span>
                  </div>
                  <div class="calib-stat">
                    Target: <span id="calibTargetText">--</span>
                  </div>
                  <div class="calib-stat">
                    Elapsed: <span id="calibElapsedText">--</span>
                  </div>
                </div>

                <div class="calib-history-picker">
                  <label for="calibHistorySelect">Saved history</label>
                  <select id="calibHistorySelect"></select>
                  <button
                    id="calibHistoryLoadBtn"
                    type="button"
                    class="calib-secondary"
                  >
                    Load Saved
                  </button>
                  <button
                    id="calibHistoryRefreshBtn"
                    type="button"
                    class="calib-secondary"
                  >
                    Refresh List
                  </button>
                </div>

                <div class="calibration-wire-test">
                  <div class="ds-field">
                    <label for="wireTestTargetC">Target Temp</label>
                    <div class="input-with-unit">
                      <input type="number" id="wireTestTargetC" step="0.1" />
                      <span class="unit-label">C</span>
                    </div>
                  </div>
                  <div class="ds-field">
                    <button
                      id="wireTestStartBtn"
                      type="button"
                      class="calib-btn"
                    >
                      Start Wire Test
                    </button>
                  </div>
                  <div class="ds-field">
                    <button
                      id="wireTestStopBtn"
                      type="button"
                      class="calib-btn calib-stop"
                    >
                      Stop Wire Test
                    </button>
                  </div>
                  <div class="status-line wide">
                    Energy Loop: <span id="wireTestState">Idle</span> | Mode:
                    <span id="wireTestMode">--</span> | Purpose:
                    <span id="wireTestPurpose">--</span> | Active:
                    <span id="wireTestActiveWire">--</span> | NTC:
                    <span id="wireTestNtcTemp">--</span> | Model:
                    <span id="wireTestModelTemp">--</span> | Packet:
                    <span id="wireTestPacket">--</span> | Frame:
                    <span id="wireTestFrame">--</span>
                  </div>
                </div>

                <div class="calibration-section">
                  <div class="calibration-section-header">
                    <h4>Floor Model Calibration</h4>
                    <span class="calibration-section-note"
                      >Use NTC as floor sensor and heatsink as ambient.</span
                    >
                  </div>
                  <div class="calibration-wire-test floor-calibration-grid">
                    <div class="ds-field">
                      <label for="floorCalTargetC">Target Temp</label>
                      <div class="input-with-unit">
                        <input type="number" id="floorCalTargetC" step="0.1" />
                        <span class="unit-label">C</span>
                      </div>
                    </div>
                    <div class="ds-field">
                      <label for="floorCalDutyPct">Duty</label>
                      <div class="input-with-unit">
                        <input
                          type="number"
                          id="floorCalDutyPct"
                          step="1"
                          min="5"
                          max="100"
                        />
                        <span class="unit-label">%</span>
                      </div>
                    </div>
                    <div class="ds-field">
                      <label for="floorCalAmbientMin">Ambient</label>
                      <div class="input-with-unit">
                        <input
                          type="number"
                          id="floorCalAmbientMin"
                          step="1"
                          min="1"
                        />
                        <span class="unit-label">min</span>
                      </div>
                    </div>
                    <div class="ds-field">
                      <label for="floorCalHeatMin">Heat</label>
                      <div class="input-with-unit">
                        <input
                          type="number"
                          id="floorCalHeatMin"
                          step="1"
                          min="1"
                        />
                        <span class="unit-label">min</span>
                      </div>
                    </div>
                    <div class="ds-field">
                      <label for="floorCalCoolMin">Cool</label>
                      <div class="input-with-unit">
                        <input
                          type="number"
                          id="floorCalCoolMin"
                          step="1"
                          min="0"
                        />
                        <span class="unit-label">min</span>
                      </div>
                    </div>
                    <div class="ds-field">
                      <label for="floorCalIntervalMs">Interval</label>
                      <div class="input-with-unit">
                        <input
                          type="number"
                          id="floorCalIntervalMs"
                          step="50"
                          min="50"
                          max="5000"
                        />
                        <span class="unit-label">ms</span>
                      </div>
                    </div>
                    <div class="ds-field">
                      <label for="floorCalWireIndex">Wire index</label>
                      <input
                        type="number"
                        id="floorCalWireIndex"
                        step="1"
                        min="1"
                        max="10"
                      />
                    </div>
                    <div class="ds-field">
                      <button
                        id="startFloorCalibBtn"
                        type="button"
                        class="calib-btn"
                      >
                        Start Floor Cal
                      </button>
                    </div>
                  </div>
                  <div class="calibration-status floor-cal-status">
                    <div class="calib-stat">
                      Stage: <span id="floorCalStageText">--</span>
                    </div>
                    <div class="calib-stat">
                      Running: <span id="floorCalRunningText">--</span>
                    </div>
                    <div class="calib-stat">
                      Calibrated: <span id="floorCalDoneText">--</span>
                    </div>
                    <div class="calib-stat">
                      Tau: <span id="floorCalTauText">--</span>
                    </div>
                    <div class="calib-stat">
                      K: <span id="floorCalKText">--</span>
                    </div>
                    <div class="calib-stat">
                      C: <span id="floorCalCText">--</span>
                    </div>
                  </div>
                </div>

                <div id="presenceProbeSection" class="calibration-section">
                  <div class="calibration-section-header">
                    <h4>Presence Probe</h4>
                    <span class="calibration-section-note"
                      >Detect connected wires while idle.</span
                    >
                  </div>
                  <div class="calibration-wire-test presence-probe-row">
                    <div class="ds-field">
                      <button
                        id="presenceProbeBtn"
                        type="button"
                        class="calib-secondary"
                      >
                        Run Presence Probe
                      </button>
                    </div>
                    <div class="ds-field status-line">
                      Status: <span id="presenceProbeStatusText">--</span>
                    </div>
                  </div>
                  <div id="presenceProbeGrid" class="presence-probe-grid"></div>
                </div>

                <div class="calibration-chart">
                  <div class="calib-chart-top">
                    <div>
                      <div class="calib-chart-title">Temperature vs Time</div>
                      <div class="calib-chart-sub">
                        Drag the chart to pan horizontally. Y axis stays
                        visible.
                      </div>
                    </div>

                    <div class="calib-chart-controls">
                      <button
                        id="calibLatestBtn"
                        type="button"
                        class="calib-secondary"
                      >
                        Most recent
                      </button>
                      <button
                        id="calibPauseBtn"
                        type="button"
                        class="calib-secondary"
                      >
                        Pause
                      </button>
                    </div>

                    <div class="calib-chart-stats">
                      <div class="calib-pill">
                        Temp: <b id="calibNowTempPill">--</b>&nbsp;C
                      </div>
                      <div class="calib-pill">
                        Time:
                        <b id="calibNowTimePill" class="calib-mono">--:--</b>
                      </div>
                      <div class="calib-pill">Max: <b>150</b>&nbsp;C</div>
                    </div>
                  </div>

                  <div class="calib-chart-shell">
                    <div class="calib-axis-col">
                      <svg id="calibYAxis" role="img" aria-label="Y axis"></svg>
                    </div>
                    <div
                      id="calibScrollWrap"
                      class="calib-scroll-wrap"
                      title="Drag to pan horizontally"
                    >
                      <svg
                        id="calibPlot"
                        role="img"
                        aria-label="Temperature chart"
                      ></svg>
                    </div>
                  </div>
                </div>

                <!-- Buttons moved to the action bar for a cleaner layout -->
              </div>
            </div>
          </div>
