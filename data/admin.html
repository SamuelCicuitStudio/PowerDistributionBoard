<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/admin.css?v=2" />
    <style>
      .user-status-global {
        position: absolute;
        top: 10px;
        right: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 1000;
      }
      .user-menu {
        position: absolute;
        top: 35px;
        right: 0;
        display: none;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
      }
      .user-menu button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
      }
      /* === Device Settings: scoped, compact, no vertical scroll === */
      #deviceSettingsTab.content,
      #deviceSettingsTab .content {
        /* in case a theme sets scroll on .content, force this tab to fit */
        padding: 14px 18px 10px;
        overflow-y: hidden;
      }
      /* Make the single box fill available width and fit the frame height */
      .user-modal-content.device-settings-box {
        width: 100%;
        max-width: 720px;
        max-height: 540px;
        margin: 0 auto;
        display: flex;
        flex-direction: column; /* grid + actions stacked */
        gap: 16px;
        overflow: hidden; /* scrolling happens inside .device-grid */
      }
      .ds-group-title {
        grid-column: 1 / -1;
        margin-top: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-left: 4px solid var(--ds-accent, rgba(255, 255, 255, 0.35));
        background: rgba(255, 255, 255, 0.06);
        font-size: 12px;
        font-weight: 800;
        letter-spacing: 0.3px;
        color: rgba(255, 255, 255, 0.95);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.22);
      }
      .ds-group-title.ds-power {
        --ds-accent: #ff3b30;
        background: rgba(255, 59, 48, 0.12);
      }
      .ds-group-title.ds-thermal-safety {
        --ds-accent: #ffb020;
        background: rgba(255, 176, 32, 0.12);
      }
      .ds-group-title.ds-thermal-model {
        --ds-accent: #a855f7;
        background: rgba(168, 85, 247, 0.12);
      }
      .ds-group-title.ds-ntc {
        --ds-accent: #22d3ee;
        background: rgba(34, 211, 238, 0.12);
      }
      .ds-group-title.ds-control {
        --ds-accent: #4d9efc;
        background: rgba(77, 158, 252, 0.12);
      }
      .ds-group-title.ds-floor {
        --ds-accent: #10b981;
        background: rgba(16, 185, 129, 0.12);
      }
      .ds-group-title.ds-nichrome {
        --ds-accent: #f97316;
        background: rgba(249, 115, 22, 0.12);
      }
      .ds-group-title.ds-loop-timing {
        --ds-accent: #20c997;
        background: rgba(32, 201, 151, 0.12);
      }
      /* Two-column grid inside the box */
      .device-settings-box .device-grid {
        display: grid;
        grid-template-columns: 1.05fr 1.15fr; /* left: device fields | right: nichrome */
        gap: 18px 28px; /* row gap | column gap */
        align-items: flex-start;
        min-width: 0;
        min-height: 0;
        flex: 1 1 auto;
        overflow-y: auto;
        padding-right: 6px; /* keep scrollbar off content */
      }
      .device-settings-box .device-col {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 0;
        min-height: 0;
      }
      /* Left column (Device Settings) as a compact 2-column grid */
      .device-settings-box .device-grid > .device-col:first-child {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px 16px;
      }
      .device-settings-box .device-grid > .device-col:first-child h3 {
        grid-column: 1 / -1;
        margin: 0 0 10px;
        font-size: 15px;
      }
      .mixed-only {
        display: none;
      }
      /* Inputs with right-side unit tag */
      .input-with-unit {
        position: relative;
      }
      .input-with-unit input {
        width: 100%;
        padding-right: 42px; /* space for unit */
      }
      .unit-label {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        opacity: 0.75;
        pointer-events: none;
      }
      /* Nichrome calibration grid: 5 x 2 for R01..R10 + 1 full-width target row */
      .nichrome-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px 12px;
      }
      .nichrome-meta {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px 12px;
      }
      .nichrome-meta .ds-field {
        min-width: 0;
      }
      .nichrome-grid .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .nichrome-grid .field label {
        font-size: 11px;
        opacity: 0.85;
      }
      .nichrome-grid .field input {
        padding: 8px;
      }
      .nichrome-grid .field.target {
        grid-column: 1 / -1; /* span entire row */
      }
      /* Actions always visible and tidy */
      .device-settings-box .user-modal-actions.round-actions {
        margin-top: 8px;
        justify-content: center;
        flex: 0 0 auto; /* always visible under the scroll area */
      }
      /* Optional: tiny responsive fallback if viewport is very short or narrow */
      @media (max-height: 640px) {
        .user-modal-content.device-settings-box {
          max-height: 440px;
        }
      }
      @media (max-width: 980px) {
        .user-modal-content.device-settings-box {
          max-width: 600px;
        }
      }
      @media (max-width: 860px) {
        .device-settings-box .device-grid {
          grid-template-columns: 1fr; /* stack columns on very narrow view */
        }
      }
    </style>
  </head>
  <body>
    <div class="ui-container">
      <!-- Global User Icon / Menu -->
      <div class="user-status-global">
        <div class="status-dot" title="Auto Mode"></div>
        <div id="wifiSignal" class="wifi-signal" title="WiFi signal">
          <img id="wifiSignalIcon" src="icons/wifi-0-bars.png" alt="WiFi signal" />
        </div>
        <div id="boardTempChip" class="temp-chip" title="Board temperature">
          <img src="icons/thermoBoard.png" alt="Board temp" />
          <span id="boardTempText">--?C</span>
        </div>
        <div id="heatsinkTempChip" class="temp-chip" title="Heatsink temperature">
          <img src="icons/thermoHeatsink.png" alt="Heatsink temp" />
          <span id="heatsinkTempText">--?C</span>
        </div>
        <div id="dcVoltageChip" class="temp-chip" title="DC bus voltage">
          <span class="chip-label">DC</span>
          <span id="dcVoltageText">--V</span>
        </div>
        <div id="dcCurrentChip" class="temp-chip" title="DC current">
          <span class="chip-label">I</span>
          <span id="dcCurrentText">--A</span>
        </div>
        <div id="eventBadge" class="event-badge" title="New warnings/errors">
          <span id="eventWarnBtn" class="event-pill warn" role="button" tabindex="0">
            <img src="icons/Warning.png" alt="Warning" />
            <span id="eventWarnCount">0</span>
          </span>
          <span id="eventErrBtn" class="event-pill err" role="button" tabindex="0">
            <img src="icons/Error.png" alt="Error" />
            <span id="eventErrCount">0</span>
          </span>
        </div>
        <div class="user-icon" onclick="toggleUserMenu()">ðŸ‘¤</div>
        <div class="user-menu" id="userMenu">
          <button id="disconnectBtn" type="button">Disconnect</button>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <div class="tab active" onclick="switchTab(0)">Dashboard</div>
        <div class="tab" onclick="switchTab(1)">User Settings</div>
        <div class="tab" onclick="switchTab(2)">Manual Control</div>
        <div class="tab" onclick="switchTab(3)">Admin Settings</div>
        <div class="tab" onclick="switchTab(4)">Device Settings</div>
        <div class="tab" onclick="switchTab(5)">Live</div>

        <!-- SINGLE vertical stack of 4 buttons -->
        <div class="sidebar-controls-vertical">
          <!-- 1) Mute -->
          <div
            class="round-button mute"
            id="muteBtn"
            onclick="toggleMute()"
            title="Mute / Unmute"
          >
            <img id="muteIcon" src="icons/volume-up-4-256.png" alt="Sound" />
          </div>

          <!-- 2) Power -->
          <button id="powerButton" class="power-button state-off" title="Power">
            <span class="ring"></span>
            <span class="label" id="powerLabel">OFF</span>
          </button>

          <!-- 3) Reboot -->
          <div
            class="round-button reset"
            onclick="rebootSystem()"
            title="Reboot"
          >
            <img src="icons/refresh.png" alt="Reset" />
          </div>

          <!-- 4) Reset -->
          <div
            class="round-button reset"
            onclick="openConfirm('reset')"
            title="Reset"
          >
            <img src="icons/redo-5-16.png" alt="Reset" />
          </div>
        </div>
      </div>

      <!-- Dashboard Tab -->
      <div class="content active" id="dashboardTab">
        <div class="content-header">
          <h2></h2>
        </div>

        <div
          class="mode-box"
          style="
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.05);
          "
        >
          <div
            class="mode-toggle"
            style="
              display: flex;
              align-items: center;
              gap: 15px;
              flex-wrap: wrap;
            "
          >
            <label>Auto</label>
            <label class="switch">
              <input type="checkbox" id="modeToggle" onchange="toggleMode()" />
              <span class="slider"></span>
            </label>
            <label>Manual</label>

            <label style="margin-left: 20px">LT</label>
            <label class="switch">
              <input type="checkbox" id="ltToggle" onchange="toggleLT()" />
              <span class="slider"></span>
            </label>

            <span style="margin-left: 30px">Ready</span>
            <div id="readyLed" class="led"></div>
            <span style="margin-left: 20px">OFF</span>
            <div id="offLed" class="led"></div>
          </div>

          <div class="controls" style="margin-top: 10px">
            <button
              id="forceCalibrationBtn"
              type="button"
              onclick="forceCalibration()"
            >
              Force Calibration
            </button>
          </div>
        </div>

        <div class="gauge-scroll-area">
          <div class="gauges">
            <!-- Voltage -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg voltage"
                      stroke-dasharray="92, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="voltageValue"
                  >
                    230V
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Voltage</div>
              <div class="gauge-label" style="font-size: 12px">
                ADC raw (/100): <span id="adcRawValue">--</span>
              </div>
            </div>

            <!-- Current -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg current"
                      stroke-dasharray="60, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="currentValue"
                  >
                    1.2A
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Current</div>
            </div>

            <!-- Temp 1 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 
                        a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="21, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 
                        a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp1Value"
                  >
                    31Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Board 01</div>
            </div>

            <!-- Temp 2 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="17, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp2Value"
                  >
                    25Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Board 02</div>
            </div>

            <!-- Temp 3 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="26, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp3Value"
                  >
                    39Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Heatsink</div>
            </div>

            <!-- Capacitance -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg voltage"
                      stroke-dasharray="0, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="capacitanceValue"
                  >
                    --mF
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Capacitance</div>
            </div>

            <!-- Temp 4 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="29, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp4Value"
                  >
                    44Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 4</div>
            </div>

            <!-- Temp 5 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="19, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp5Value"
                  >
                    28Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 5</div>
            </div>

            <!-- Temp 6 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="24, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp6Value"
                  >
                    36Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 6</div>
            </div>

            <!-- Temp 7 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="14, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp7Value"
                  >
                    22Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 7</div>
            </div>

            <!-- Temp 8 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="32, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp8Value"
                  >
                    48Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 8</div>
            </div>

            <!-- Temp 9 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="18, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp9Value"
                  >
                    27Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 9</div>
            </div>

            <!-- Temp 10 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="22, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp10Value"
                  >
                    33Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 10</div>
            </div>

            <!-- Temp 11 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="27, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp11Value"
                  >
                    41Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 11</div>
            </div>

            <!-- Temp 12 -->
            <div class="gauge-card">
              <div class="gauge">
                <svg viewBox="0 0 36 36" class="gauge-svg">
                  <g transform="rotate(-90 18 18)">
                    <path
                      class="gauge-bg"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                    <path
                      class="gauge-fg temperature"
                      stroke-dasharray="19, 100"
                      d="M18 2.0845 a15.9155 15.9155 0 1 1 0 31.831 a15.9155 15.9155 0 1 1 0 -31.831"
                    />
                  </g>
                  <text
                    x="18"
                    y="18"
                    class="gauge-value"
                    transform="rotate(90 18 18)"
                    id="temp12Value"
                  >
                    29Â°C
                  </text>
                </svg>
              </div>
              <div class="gauge-label">Temp 12</div>
            </div>
          </div>
        </div>
      </div>

      <!-- User Settings Tab -->
      <div class="content" id="userSettingsTab">
        <div class="content-header">
          <h2></h2>
        </div>

        <div
          class="user-modal-content zoom-box"
          style="width: 100%; max-width: 400px"
        >
          <input
            type="password"
            id="userCurrentPassword"
            autocomplete="current-password"
            placeholder="Current Password"
          />
          <input
            type="password"
            id="userNewPassword"
            autocomplete="new-password"
            placeholder="New Password"
          />
          <input
            type="text"
            id="userDeviceId"
            autocomplete="off"
            placeholder="New Device ID"
          />
          <div class="user-modal-actions round-actions">
            <div class="round-button save" onclick="saveUserSettings()">
              <img src="icons/ok_tank.png" alt="Save" />
            </div>
            <div class="round-button cancel" onclick="resetUserSettings()">
              <img src="icons/close.png" alt="Cancel" />
            </div>
          </div>
        </div>

        <div class="section-header">Output Access</div>
        <div class="manual-outputs" id="userAccessGrid"></div>
      </div>

      <!-- Manual Control Tab -->
      <div class="content" id="manualControlTab">
        <div class="content-header">
          <h2></h2>
        </div>

        <div class="mode-box">
          <div
            class="controls"
            style="
              display: flex;
              align-items: center;
              gap: 20px;
              flex-wrap: wrap;
            "
          >
            <label>Fan</label>
            <input type="range" min="0" max="100" id="fanSlider" />
            <label>Relay</label>
            <label class="switch">
              <input type="checkbox" id="relayToggle" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="manual-outputs" id="manualOutputs"></div>
      </div>

      <!-- Admin Settings Tab -->
      <div class="content" id="adminSettingsTab">
        <div class="content-header">
          <h2></h2>
        </div>

        <div
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100% - 80px);
          "
        >
          <div
            class="user-modal-content zoom-box"
            style="width: 100%; max-width: 400px"
          >
            <input
              type="password"
              id="adminCurrentPassword"
              placeholder="Current Password"
            />
            <input
              type="text"
              id="adminUsername"
              placeholder="New Admin Username"
            />
            <input
              type="password"
              id="adminPassword"
              placeholder="New Admin Password"
            />

            <hr style="margin: 20px 0; opacity: 0.2" />

            <input type="text" id="wifiSSID" placeholder="Wi-Fi SSID" />
            <input
              type="password"
              id="wifiPassword"
              placeholder="Wi-Fi Password"
            />

            <div class="user-modal-actions round-actions">
              <div class="round-button save" onclick="saveAdminSettings()">
                <img src="icons/ok_tank.png" alt="Save" />
              </div>
              <div class="round-button cancel" onclick="resetAdminSettings()">
                <img src="icons/close.png" alt="Cancel" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Device Settings Tab -->
      <div class="content" id="deviceSettingsTab">
        <div class="content-header">
          <h2></h2>
        </div>

        <div
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100% - 80px);
          "
        >
          <!-- Device Settings: ONE SINGLE BOX -->
          <div class="user-modal-content zoom-box device-settings-box">
            <div class="device-grid">
              <!-- Left column: existing device fields -->
              <section class="device-col device-col--left">
                <h3>Device Settings</h3>

                <div class="ds-group-title ds-power">Sampling &amp; Power</div>

                <div class="ds-field">
                  <label for="acFrequency">Sampling Rate</label>
                  <div class="input-with-unit">
                    <input type="number" id="acFrequency" min="50" max="500" />
                    <span class="unit-label">Hz</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="chargeResistor">Charge Resistor</label>
                  <div class="input-with-unit">
                    <input type="number" id="chargeResistor" />
                    <span class="unit-label">Î©</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="currLimit">Current Trip Limit</label>
                  <div class="input-with-unit">
                    <input type="number" id="currLimit" step="0.1" />
                    <span class="unit-label">A</span>
                  </div>
                </div>

                <div class="ds-group-title ds-thermal-safety">
                  Thermal Safety
                </div>

                <div class="ds-field">
                  <label for="tempWarnC">Temp Warning</label>
                  <div class="input-with-unit">
                    <input type="number" id="tempWarnC" step="0.1" />
                    <span class="unit-label">Â°C</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="tempTripC">Temp Trip (Shutdown)</label>
                  <div class="input-with-unit">
                    <input type="number" id="tempTripC" step="0.1" />
                    <span class="unit-label">Â°C</span>
                  </div>
                </div>

                <div class="ds-group-title ds-thermal-model">Thermal Model</div>

                <div class="ds-field">
                  <label for="idleCurrentA">Idle Current Baseline</label>
                  <div class="input-with-unit">
                    <input type="number" id="idleCurrentA" step="0.01" />
                    <span class="unit-label">A</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="wireTauSec">Wire Tau (time constant)</label>
                  <div class="input-with-unit">
                    <input type="number" id="wireTauSec" step="0.01" />
                    <span class="unit-label">s</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="wireKLoss">Heat Loss k</label>
                  <div class="input-with-unit">
                    <input type="number" id="wireKLoss" step="0.001" />
                    <span class="unit-label">W/K</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="wireThermalC">Thermal Mass C</label>
                  <div class="input-with-unit">
                    <input type="number" id="wireThermalC" step="0.01" />
                    <span class="unit-label">J/K</span>
                  </div>
                </div>

                <div class="ds-group-title ds-control">PI Control</div>

                <div class="ds-field">
                  <label for="wireKp">Wire Kp</label>
                  <input type="number" id="wireKp" step="0.001" />
                </div>

                <div class="ds-field">
                  <label for="wireKi">Wire Ki</label>
                  <input type="number" id="wireKi" step="0.001" />
                </div>

                <div class="ds-field">
                  <label for="floorKp">Floor Kp</label>
                  <input type="number" id="floorKp" step="0.001" />
                </div>

                <div class="ds-field">
                  <label for="floorKi">Floor Ki</label>
                  <input type="number" id="floorKi" step="0.001" />
                </div>

                <div class="ds-group-title ds-ntc">NTC Input</div>

                <div class="ds-field">
                  <label for="ntcBeta">NTC Beta</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcBeta" step="1" />
                    <span class="unit-label">K</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="ntcR0">NTC R0</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcR0" step="1" />
                    <span class="unit-label">Ohm</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="ntcFixedRes">NTC Fixed Resistor</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcFixedRes" step="1" />
                    <span class="unit-label">Ohm</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="ntcMinC">NTC Min Temp</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcMinC" step="0.1" />
                    <span class="unit-label">C</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="ntcMaxC">NTC Max Temp</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcMaxC" step="0.1" />
                    <span class="unit-label">C</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="ntcSamples">NTC Samples</label>
                  <input
                    type="number"
                    id="ntcSamples"
                    min="1"
                    max="64"
                    step="1"
                  />
                </div>

                <div class="ds-field">
                  <label for="ntcGateIndex">NTC Wire Index</label>
                  <input
                    type="number"
                    id="ntcGateIndex"
                    min="1"
                    max="10"
                    step="1"
                  />
                </div>

                <div class="ds-field">
                  <label for="ntcPressMv">Button Press Threshold</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcPressMv" step="1" />
                    <span class="unit-label">mV</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="ntcReleaseMv">Button Release Threshold</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcReleaseMv" step="1" />
                    <span class="unit-label">mV</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="ntcDebounceMs">Button Debounce</label>
                  <div class="input-with-unit">
                    <input type="number" id="ntcDebounceMs" step="1" />
                    <span class="unit-label">ms</span>
                  </div>
                </div>

                <div class="ds-group-title ds-loop-timing">Loop Timing</div>

                <div class="ds-field" id="onTimeField" style="display: none">
                  <label for="onTime">ON Time</label>
                  <div class="input-with-unit">
                    <input type="number" id="onTime" />
                    <span class="unit-label">ms</span>
                  </div>
                </div>

                <div class="ds-field" id="offTimeField" style="display: none">
                  <label for="offTime">OFF Time</label>
                  <div class="input-with-unit">
                    <input type="number" id="offTime" />
                    <span class="unit-label">ms</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="loopModeSelect">Loop Mode</label>
                  <select id="loopModeSelect">
                    <option value="advanced">Advanced (grouped)</option>
                    <option value="sequential">
                      Sequential (coolest-first)
                    </option>
                    <option value="mixed">
                      Mixed (preheat + keep-warm, sequential pulses)
                    </option>
                  </select>
                </div>

                <div class="ds-field mixed-only" id="mixPreheatField">
                  <label
                    for="mixPreheatMs"
                    title="Bulk preheat duration before holding temperature"
                    >Mixed Preheat Duration</label
                  >
                  <div class="input-with-unit">
                    <input
                      type="number"
                      id="mixPreheatMs"
                      min="0"
                      title="How long to bulk-preheat all allowed wires before settling into hold"
                    />
                    <span class="unit-label">ms</span>
                  </div>
                </div>

                <div class="ds-field mixed-only" id="mixPreheatOnField">
                  <label
                    for="mixPreheatOnMs"
                    title="Primary wire pulse width during preheat frames"
                    >Preheat Pulse (primary)</label
                  >
                  <div class="input-with-unit">
                    <input
                      type="number"
                      id="mixPreheatOnMs"
                      min="1"
                      title="Pulse length for the active wire while preheating (sequential)"
                    />
                    <span class="unit-label">ms</span>
                  </div>
                </div>

                <div class="ds-field mixed-only" id="mixKeepField">
                  <label
                    for="mixKeepMs"
                    title="Keep-warm pulse for the other wires in each frame"
                    >Keep-warm Pulse (others)</label
                  >
                  <div class="input-with-unit">
                    <input
                      type="number"
                      id="mixKeepMs"
                      min="0"
                      title="Small serialized pulse for non-primary wires to reduce cooldown"
                    />
                    <span class="unit-label">ms</span>
                  </div>
                </div>

                <div class="ds-field mixed-only" id="mixFrameField">
                  <label
                    for="mixFrameMs"
                    title="Frame period that contains all serialized pulses"
                    >Frame Period</label
                  >
                  <div class="input-with-unit">
                    <input
                      type="number"
                      id="mixFrameMs"
                      min="10"
                      title="Total frame length; all mixed pulses are serialized within this window"
                    />
                    <span class="unit-label">ms</span>
                  </div>
                </div>

                <div class="ds-field">
                  <label for="timingModeSelect">Timing Settings</label>
                  <select id="timingModeSelect">
                    <option value="preset">
                      Normal (Hot / Medium / Gentle)
                    </option>
                    <option value="manual">Advanced (manual ON/OFF)</option>
                  </select>
                </div>

                <div class="ds-field" id="timingProfileField">
                  <label for="timingProfileSelect">Heat Profile</label>
                  <select id="timingProfileSelect">
                    <option value="hot">Hot / Fast</option>
                    <option value="medium">Medium</option>
                    <option value="gentle">Gentle / Cool</option>
                  </select>
                </div>

                <div class="ds-field" id="timingResolvedField">
                  <label for="timingResolved">Resolved Timing</label>
                  <input id="timingResolved" type="text" readonly />
                </div>

                <div class="ds-field">
                  <label for="wireGauge">Wire Gauge (AWG)</label>
                  <input
                    id="wireGauge"
                    type="number"
                    step="1"
                    min="1"
                    max="40"
                    inputmode="numeric"
                  />
                </div>
              </section>

              <!-- Right column: Nichrome -->
              <section class="device-col device-col--right">
                <h3>Nichrome Calibration</h3>
                <div class="ds-group-title ds-floor">Floor Settings</div>
                <div class="nichrome-meta">
                  <div class="ds-field">
                    <label for="floorThicknessMm"
                      >Floor Thickness (20-50 mm)</label
                    >
                    <div class="input-with-unit">
                      <input
                        type="number"
                        id="floorThicknessMm"
                        step="0.1"
                        min="20"
                        max="50"
                      />
                      <span class="unit-label">mm</span>
                    </div>
                  </div>
                  <div class="ds-field">
                    <label for="nichromeFinalTempC">Nichrome Final Temp</label>
                    <div class="input-with-unit">
                      <input type="number" id="nichromeFinalTempC" step="0.1" />
                      <span class="unit-label">C</span>
                    </div>
                  </div>
                  <div class="ds-field">
                    <label for="floorMaterial">Floor Material</label>
                    <select id="floorMaterial">
                      <option value="wood">Wood</option>
                      <option value="epoxy">Epoxy</option>
                      <option value="concrete">Concrete</option>
                      <option value="slate">Slate</option>
                      <option value="marble">Marble</option>
                      <option value="granite">Granite</option>
                    </select>
                  </div>
                  <div class="ds-field">
                    <label for="floorMaxC">Max Floor Temp (<= 35 C)</label>
                    <div class="input-with-unit">
                      <input type="number" id="floorMaxC" step="0.1" max="35" />
                      <span class="unit-label">C</span>
                    </div>
                  </div>
                </div>
                <div class="ds-group-title ds-nichrome">
                  Nichrome Calibration
                </div>
                <div class="nichrome-grid">
                  <!-- New: global Î©/m -->
                  <div class="field">
                    <label for="wireOhmPerM">Wire Resistivity (Î©/m)</label>
                    <input
                      id="wireOhmPerM"
                      type="number"
                      step="0.01"
                      inputmode="decimal"
                    />
                  </div>
                  <!-- R01..R10 -->
                  <div class="field">
                    <label for="r01ohm">R01 (Î©)</label>
                    <input
                      id="r01ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r02ohm">R02 (Î©)</label>
                    <input
                      id="r02ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r03ohm">R03 (Î©)</label>
                    <input
                      id="r03ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r04ohm">R04 (Î©)</label>
                    <input
                      id="r04ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r05ohm">R05 (Î©)</label>
                    <input
                      id="r05ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r06ohm">R06 (Î©)</label>
                    <input
                      id="r06ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r07ohm">R07 (Î©)</label>
                    <input
                      id="r07ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r08ohm">R08 (Î©)</label>
                    <input
                      id="r08ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r09ohm">R09 (Î©)</label>
                    <input
                      id="r09ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                  <div class="field">
                    <label for="r10ohm">R10 (Î©)</label>
                    <input
                      id="r10ohm"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>

                  <!-- Target for all -->
                  <div class="field target">
                    <label for="rTarget">Target Resistance (Î©)</label>
                    <input
                      id="rTarget"
                      type="number"
                      step="0.1"
                      inputmode="decimal"
                    />
                  </div>
                </div>
              </section>
            </div>

            <!-- One shared action row -->
            <div class="user-modal-actions round-actions">
              <div class="round-button save" onclick="saveDeviceAndNichrome()">
                <img src="icons/ok_tank.png" alt="Save" />
              </div>
              <div
                class="round-button cancel"
                onclick="resetDeviceAndNichrome()"
              >
                <img src="icons/close.png" alt="Cancel" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Live Tab -->
      <!-- Live Tab -->
      <div class="content" id="liveTab">
        <div class="content-header">
          <h2></h2>
        </div>

        <div class="live-wrap">
          <!-- Legend -->
          <div class="live-legend">
            <span class="chip on-chip">
              <span class="dot-sample on"></span>
              ON (energized)
            </span>
            <span class="chip off-chip">
              <span class="dot-sample off"></span>
              OFF (connected)
            </span>
            <span class="chip cyan-chip">
              <span class="dot-sample cyan"></span>
              No wire / Not connected
            </span>
          </div>

          <!-- Centralized radial stage -->
          <div class="live-stage">
            <!-- SVG: traces + dots + temp circles -->
            <svg
              class="live-overlay"
              viewBox="0 0 100 100"
              preserveAspectRatio="xMidYMid meet"
            ></svg>

            <!-- Center core: current session data -->
            <div class="live-core">
              <div class="live-core-header">
                <div class="live-core-label">Current Session</div>
              </div>

              <div
                id="sessionStatus"
                class="session-status session-status-idle"
              >
                No active session
              </div>

              <div class="live-core-metrics">
                <div class="metric">
                  <div class="metric-label">Energy</div>
                  <div id="sessionEnergy" class="metric-value">-- Wh</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Duration</div>
                  <div id="sessionDuration" class="metric-value">-- s</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Peak Power</div>
                  <div id="sessionPeakPower" class="metric-value">-- W</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Peak Current</div>
                  <div id="sessionPeakCurrent" class="metric-value">-- A</div>
                </div>
              </div>

              <div class="live-core-actions">
                <button
                  id="sessionHistoryBtn"
                  type="button"
                  class="session-history-btn"
                >
                  History
                </button>
                <button
                  id="calibrationBtn"
                  type="button"
                  class="session-history-btn session-calib-btn"
                >
                  Calibration
                </button>
                <button
                  id="errorBtn"
                  type="button"
                  class="session-history-btn session-error-btn"
                >
                  Error
                </button>
              </div>
            </div>
          </div>

          <!-- Session History modal (unchanged skeleton, just kept below) -->
          <div id="sessionHistoryModal" class="session-history-modal">
            <div
              class="session-history-backdrop"
              onclick="closeSessionHistory()"
            ></div>
            <div class="session-history-content">
              <div class="session-history-header">
                <h3>Session History</h3>
                <button
                  type="button"
                  class="session-history-close"
                  onclick="closeSessionHistory()"
                >
                  âœ•
                </button>
              </div>
              <div class="session-history-body">
                <p class="session-history-placeholder">
                  No history loaded yet. Backend will populate this table.
                </p>
                <table class="session-history-table">
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Duration</th>
                      <th>Energy (Wh)</th>
                      <th>Peak P (W)</th>
                      <th>Peak I (A)</th>
                    </tr>
                  </thead>
                  <tbody id="sessionHistoryTableBody">
                    <!-- rows from backend -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Calibration modal -->
          <div id="calibrationModal" class="calibration-modal">
            <div
              class="calibration-backdrop"
              onclick="closeCalibrationModal()"
            ></div>
            <div class="calibration-content">
              <div class="calibration-header">
                <h3>Calibration</h3>
                <div style="display: flex; align-items: center; gap: 8px">
                  <button
                    id="calibrationInfoBtn"
                    type="button"
                    class="calib-btn"
                    style="padding: 4px 8px; min-width: 32px"
                  >
                    ?
                  </button>
                  <button
                    type="button"
                    class="calibration-close"
                    onclick="closeCalibrationModal()"
                  >
                    x
                  </button>
                </div>
              </div>
              <div class="calibration-body">
                <div
                  id="calibrationInfoPopover"
                  class="calibration-info-popover"
                  aria-hidden="true"
                >
                  <div class="calibration-info-header">
                    <div class="calibration-info-title">Calibration help</div>
                    <button
                      id="calibrationInfoCloseBtn"
                      type="button"
                      class="calibration-info-close"
                    >
                      x
                    </button>
                  </div>
                  <div class="calibration-info-content">
                    <div class="calibration-info-grid">
                      <div class="calibration-info-card">
                        <div class="calibration-info-icon">1</div>
                        <div class="calibration-info-card-title">
                          NTC calibration
                        </div>
                        <div class="calibration-info-card-text">
                          Calibrates the NTC using a known reference
                          temperature. Leave the field blank to use the heatsink
                          temperature automatically. This does not heat the
                          wire.
                        </div>
                      </div>
                      <div class="calibration-info-card">
                        <div class="calibration-info-icon">2</div>
                        <div class="calibration-info-card-title">
                          Temp model calibration
                        </div>
                        <div class="calibration-info-card-text">
                          Records temperature and time while the system drives a
                          repeatable PWM profile. Use the resulting curve to fit
                          Ï„/k/C so the model matches real measurements.
                        </div>
                      </div>
                      <div class="calibration-info-card">
                        <div class="calibration-info-icon">3</div>
                        <div class="calibration-info-card-title">Wire test</div>
                        <div class="calibration-info-card-text">
                          Runs the PI controller to reach and hold a target
                          temperature on the NTC-attached wire. This is a live
                          test and does not save history.
                        </div>
                      </div>
                    </div>

                    <div class="calibration-info-actions">
                      <div class="calibration-info-actions-title">Buttons</div>
                      <ul>
                        <li>
                          <strong>NTC Calibration:</strong> Start NTC recording
                          (optional) and use â€œCalibrate NTCâ€ to compute R0.
                        </li>
                        <li>
                          <strong>Temp Model Calibration:</strong> Start/stop
                          the model capture while PWM runs.
                        </li>
                        <li>
                          <strong>Start/Stop Wire Test:</strong> Hold target
                          temperature (PI control).
                        </li>
                        <li>
                          <strong>Load History / Resume Live:</strong> View
                          saved buffer or live feed.
                        </li>
                        <li>
                          <strong>Clear Data:</strong> Clears the buffer and
                          removes the saved file.
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="calibration-hero">
                  <h4>Simple steps</h4>
                  <div class="cal-steps">
                    <div class="cal-step">
                      <span class="dot">1</span>
                      <p>
                        NTC calibrate<br />
                        <span class="hint"
                          >Use heatsink temp or enter a ref; no heating.</span
                        >
                      </p>
                    </div>
                    <div class="cal-step">
                      <span class="dot">2</span>
                      <p>
                        Model capture<br />
                        <span class="hint"
                          >Start Temp Model Calibration to log heat/cool with
                          PWM.</span
                        >
                      </p>
                    </div>
                    <div class="cal-step">
                      <span class="dot">3</span>
                      <p>
                        Wire test<br />
                        <span class="hint"
                          >Hold a target temp and verify control (PI, no
                          logging).</span
                        >
                </p>
              </div>
            </div>
          </div>

          <!-- Error details modal -->
          <div id="errorModal" class="error-modal">
            <div class="error-backdrop" onclick="closeErrorModal()"></div>
            <div class="error-content">
              <div class="error-header">
                <h3 id="eventModalTitle">Last Stop / Error</h3>
                <button
                  type="button"
                  class="error-close"
                  onclick="closeErrorModal()"
                >
                  x
                </button>
              </div>
              <div class="error-body">
                <div class="error-row" id="errorStateRow">
                  <span class="error-label">Current state</span>
                  <span id="errorStateText">--</span>
                </div>
                <div class="error-section" id="lastErrorSection">
                  <div class="error-title">Last error</div>
                  <div class="error-row">
                    <span class="error-label">Reason</span>
                    <span id="errorReasonText">--</span>
                  </div>
                  <div class="error-row">
                    <span class="error-label">Time</span>
                    <span id="errorTimeText">--</span>
                  </div>
                </div>
                <div class="error-section" id="lastStopSection">
                  <div class="error-title">Last stop</div>
                  <div class="error-row">
                    <span class="error-label">Reason</span>
                    <span id="stopReasonText">--</span>
                  </div>
                  <div class="error-row">
                    <span class="error-label">Time</span>
                    <span id="stopTimeText">--</span>
                  </div>
                </div>
                <div class="error-section" id="warningHistorySection">
                  <div class="error-title">Warnings (last 10)</div>
                  <div id="warningList" class="error-list">
                    <div class="error-empty">No warnings logged yet.</div>
                  </div>
                </div>
                <div class="error-section" id="errorHistorySection">
                  <div class="error-title">Errors (last 10)</div>
                  <div id="errorList" class="error-list">
                    <div class="error-empty">No errors logged yet.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

                <div class="calib-actionbar">
                  <div class="calib-action-group">
                    <button
                      id="startNtcCalibBtn"
                      type="button"
                      class="calib-btn"
                    >
                      NTC Calibration
                    </button>
                    <button
                      id="startModelCalibBtn"
                      type="button"
                      class="calib-btn"
                    >
                      Temp Model Calibration
                    </button>
                    <button
                      id="stopCalibBtn"
                      type="button"
                      class="calib-btn calib-stop"
                    >
                      Stop &amp; Save
                    </button>
                  </div>
                  <div class="calib-action-group">
                    <button
                      id="calibHistoryBtn"
                      type="button"
                      class="calib-secondary"
                    >
                      Load History
                    </button>
                    <button
                      id="calibClearBtn"
                      type="button"
                      class="calib-secondary calib-danger"
                    >
                      Clear Data
                    </button>
                  </div>
                </div>

                <div class="calibration-status">
                  <div class="calib-stat">
                    Status: <span id="calibStatusText">Idle</span>
                  </div>
                  <div class="calib-stat">
                    Mode: <span id="calibModeText">--</span>
                  </div>
                  <div class="calib-stat">
                    Samples: <span id="calibCountText">0</span>
                  </div>
                  <div class="calib-stat">
                    Interval: <span id="calibIntervalText">--</span>
                  </div>
                  <div class="calib-stat">
                    Temp: <span id="calibTempText">--</span>
                  </div>
                </div>

                <div class="calib-history-picker">
                  <label for="calibHistorySelect">Saved history</label>
                  <select id="calibHistorySelect"></select>
                  <button
                    id="calibHistoryLoadBtn"
                    type="button"
                    class="calib-secondary"
                  >
                    Load Saved
                  </button>
                  <button
                    id="calibHistoryRefreshBtn"
                    type="button"
                    class="calib-secondary"
                  >
                    Refresh List
                  </button>
                </div>

                <div class="calibration-wire-test">
                  <div class="ds-field">
                    <label for="wireTestTargetC">Wire Target Temp</label>
                    <div class="input-with-unit">
                      <input type="number" id="wireTestTargetC" step="0.1" />
                      <span class="unit-label">C</span>
                    </div>
                  </div>
                  <div class="ds-field">
                    <label for="wireTestWireIndex">Wire Index</label>
                    <input
                      type="number"
                      id="wireTestWireIndex"
                      min="1"
                      max="10"
                      step="1"
                    />
                  </div>
                  <div class="ds-field">
                    <button
                      id="wireTestStartBtn"
                      type="button"
                      class="calib-btn"
                    >
                      Start Wire Test
                    </button>
                  </div>
                  <div class="ds-field">
                    <button
                      id="wireTestStopBtn"
                      type="button"
                      class="calib-btn calib-stop"
                    >
                      Stop Wire Test
                    </button>
                  </div>
                  <div class="status-line wide">
                    Wire Test: <span id="wireTestState">Idle</span> | Temp:
                    <span id="wireTestTemp">--</span> | Duty:
                    <span id="wireTestDuty">--</span> | On/Off:
                    <span id="wireTestOnOff">--</span>
                  </div>
                  <div class="calib-inline-row wide">
                    <label for="ntcCalRef" class="calib-inline-label"
                      >NTC Calibrate</label
                    >
                    <input
                      type="number"
                      id="ntcCalRef"
                      step="0.1"
                      placeholder="Ref temp (blank = heatsink)"
                      class="calib-inline-input"
                    />
                    <button
                      id="ntcCalibrateBtn"
                      type="button"
                      class="calib-btn"
                    >
                      Calibrate NTC
                    </button>
                    <span
                      id="ntcCalibrateStatus"
                      class="calib-inline-status"
                    ></span>
                  </div>
                </div>

                <div class="calib-model-card">
                  <div class="calib-model-header">
                    <div>
                      <div class="calib-chart-title">
                        Model &amp; PI suggestions
                      </div>
                      <div class="calib-chart-sub">
                        Based on last calibration samples (power) and current
                        thermal params.
                      </div>
                    </div>
                    <div class="calib-chart-controls">
                      <button
                        id="calibSuggestRefresh"
                        type="button"
                        class="calib-secondary"
                      >
                        Refresh
                      </button>
                      <button
                        id="calibSuggestFromHistory"
                        type="button"
                        class="calib-secondary"
                      >
                        Use Saved History
                      </button>
                      <button
                        id="calibPersistBtn"
                        type="button"
                        class="calib-secondary calib-save"
                      >
                        Persist &amp; Reload
                      </button>
                    </div>
                  </div>

                  <div class="calib-model-grid">
                    <div class="calib-stat-card">
                      <div class="calib-stat-label">Thermal model</div>
                      <div class="calib-stat-row">
                        Ï„: <span id="calibTauText">--</span> s
                      </div>
                      <div class="calib-stat-row">
                        k loss: <span id="calibKText">--</span> W/K
                      </div>
                      <div class="calib-stat-row">
                        C: <span id="calibCText">--</span> J/K
                      </div>
                      <div class="calib-stat-row">
                        Max P (calib): <span id="calibPmaxText">--</span> W
                      </div>
                    </div>
                    <div class="calib-stat-card">
                      <div class="calib-stat-label">Wire PI (suggested)</div>
                      <div class="calib-stat-row">
                        Kp: <span id="calibWireKpSug">--</span>
                      </div>
                      <div class="calib-stat-row">
                        Ki: <span id="calibWireKiSug">--</span>
                      </div>
                      <div class="calib-stat-row muted">
                        Current Kp/Ki: <span id="calibWireKpCur">--</span> /
                        <span id="calibWireKiCur">--</span>
                      </div>
                    </div>
                    <div class="calib-stat-card">
                      <div class="calib-stat-label">Floor PI (suggested)</div>
                      <div class="calib-stat-row">
                        Kp: <span id="calibFloorKpSug">--</span>
                      </div>
                      <div class="calib-stat-row">
                        Ki: <span id="calibFloorKiSug">--</span>
                      </div>
                      <div class="calib-stat-row muted">
                        Current Kp/Ki: <span id="calibFloorKpCur">--</span> /
                        <span id="calibFloorKiCur">--</span>
                      </div>
                    </div>
                  </div>
                  <div class="calib-model-note">
                    Click â€œPersist &amp; Reloadâ€ to save suggested values into
                    NVS and reload settings.
                  </div>
                </div>

                <div class="calibration-chart">
                  <div class="calib-chart-top">
                    <div>
                      <div class="calib-chart-title">Temperature vs Time</div>
                      <div class="calib-chart-sub">
                        Drag the chart to pan horizontally. Y axis stays
                        visible.
                      </div>
                    </div>

                    <div class="calib-chart-controls">
                      <button
                        id="calibLatestBtn"
                        type="button"
                        class="calib-secondary"
                      >
                        Most recent
                      </button>
                      <button
                        id="calibPauseBtn"
                        type="button"
                        class="calib-secondary"
                      >
                        Pause
                      </button>
                    </div>

                    <div class="calib-chart-stats">
                      <div class="calib-pill">
                        Temp: <b id="calibNowTempPill">--</b>&nbsp;C
                      </div>
                      <div class="calib-pill">
                        Time:
                        <b id="calibNowTimePill" class="calib-mono">--:--</b>
                      </div>
                      <div class="calib-pill">Max: <b>150</b>&nbsp;C</div>
                    </div>
                  </div>

                  <div class="calib-chart-shell">
                    <div class="calib-axis-col">
                      <svg id="calibYAxis" role="img" aria-label="Y axis"></svg>
                    </div>
                    <div
                      id="calibScrollWrap"
                      class="calib-scroll-wrap"
                      title="Drag to pan horizontally"
                    >
                      <svg
                        id="calibPlot"
                        role="img"
                        aria-label="Temperature chart"
                      ></svg>
                    </div>
                  </div>
                </div>

                <!-- Buttons moved to the action bar for a cleaner layout -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">&copy; 2025 Power Distribution Admin Interface</div>
    </div>

    <!-- enable/disable: set window.USE_MOCK=true/false before mock.js -->
    <script>
      window.USE_MOCK = false;
    </script>
    <script src="js/admin.js"></script>

    <!-- Confirm dialog -->
    <div id="confirmModal" class="user-modal" style="display: none">
      <div
        class="user-modal-content zoom-box"
        style="max-width: 380px; text-align: center"
      >
        <h3 id="confirmTitle">Confirm Action</h3>
        <p id="confirmMessage">Are you sure?</p>

        <div class="user-modal-actions">
          <button id="confirmCancelBtn">Cancel</button>
          <button id="confirmOkBtn" class="danger">Yes, do it</button>
        </div>
      </div>
    </div>
  </body>

  <style>
    /* === Fixed App Stage (change these if you want another size) === */
    :root {
      --APP_W: 980px;
      --APP_H: 640px;
    }
    /* Don't let the layout collapse below the fixed stage */
    html,
    body {
      min-width: var(--APP_W);
      min-height: var(--APP_H);
      overflow: auto; /* scrollbars if window is smaller */
    }
    /* Pin the whole admin UI to a fixed box */
    .ui-container {
      width: var(--APP_W);
      height: var(--APP_H);
      min-width: var(--APP_W);
      min-height: var(--APP_H);
      max-width: var(--APP_W);
      max-height: var(--APP_H);
      margin: 0 auto; /* centered if window gets wider */
      overflow: hidden; /* avoid inner jiggle/resizes */
      box-sizing: border-box;
    }
    /* Neutralize narrow/short responsive fallbacks */
    @media (max-width: 99999px) {
      /* keep two columns in device settings even on small windows */
      .device-settings-box .device-grid {
        grid-template-columns: 1fr 1fr !important;
      }
    }
    @media (max-width: 980px), (max-height: 640px) {
      /* keep the same fixed size even if viewport goes below */
      .ui-container {
        width: var(--APP_W);
        height: var(--APP_H);
      }
    }
  </style>
</html>
